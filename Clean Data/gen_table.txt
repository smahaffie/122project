import sqlite3, csv

'''
Contains function to generate sql tables from csv files 
'''

CREATE TABLE main
 (school_id varchar(8),
name varchar(30),
school_type varchar(30),
 rating varchar(3));

CREATE TABLE act
(school_id varchar(8),
category varchar(20),
category_type varchar(20),
year integer,
composite_score_mean real,
total_tested integer);

.separator ","
.import cleaned_ACT.csv act

CREATE TABLE cep
(school_id varchar(8),
graduates integer,
enrollment_pct real,
persist_pct real);

.separator ","
.import cleaned_CEP.csv


CREATE TABLE addrs
(school_id varchar(8),
address varchar(100));

CREATE TABLE fot
(school_id varchar(8),fot real,num_fresh integer);

CREATE TABLE websites 
(school_id varchar(8), website varchar(100));

'''
Below is the python code to connect to the above generated database and
calculate the city wide act score, enrollment percentage, persistance percentage,
and freshman on track and then creates another table called averages that has as columns
statistic - the statistic in question, and average - the city wide average for that statistic
'''

connection = sqlite3.connect('../schoolfinder/CHSF.db')
c = connection.cursor()

ACT_query = '''SELECT sum(total_tested*
composite_score_mean)/sum(total_tested) AS average
FROM act WHERE year = 2015 AND category = "Overall" 
AND category_type = "Overall";'''

r = c.execute(ACT_query)

average_ACT = r.fetchall()
average_ACT = average_ACT[0][0]

EPCT_query = '''SELECT sum(graduates*
enrollment_pct)/sum(graduates) FROM cep;'''

r = c.execute(EPCT_query)
average_epct = r.fetchall()
average_epct = average_epct[0][0]

PPCT_query = '''SELECT sum(graduates*persist_pct)
/sum(graduates) FROM cep;'''

r = c.execute(PPCT_query)
average_ppct = r.fetchall()
average_ppct = average_ppct[0][0]

FOT_query = '''SELECT sum(num_fresh*fot)/
sum(num_fresh) FROM fot;'''

r = c.execute(FOT_query)
average_on_track_rate = r.fetchall()
average_on_track_rate = average_on_track_rate[0][0]

gen_average_table = '''CREATE TABLE averages (
    statistic varchar(10),
    average float(6));
    INSERT INTO averages (statistic, average),
    VALUES ('FOT', ?), ('PPCT', ?), ('EPCT', ?), ('ACT', ?)'''

r = c.execute(gen_average_table, (average_on_track_rate, average_ppct, average_epct, average_ACT))
